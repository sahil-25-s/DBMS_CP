{% extends "base.html" %}

{% block title %}Book Seats - {{ show.title }} - MovieHub{% endblock %}

{% block content %}
<div class="container">
    <div class="booking-container">
        <!-- Show Information -->
        <div class="booking-header">
            <div class="show-info-card">
                <h1><i class="fas fa-ticket-alt"></i> Book Your Seats</h1>
                <div class="show-details">
                    <div class="show-detail">
                        <strong>{{ show.title }}</strong>
                    </div>
                    <div class="show-detail">
                        <i class="fas fa-building"></i>
                        {{ show.theater_name }}, {{ show.location }}
                    </div>
                    <div class="show-detail">
                        <i class="fas fa-calendar"></i>
                        {{ show.show_date.strftime('%A, %B %d, %Y') }}
                    </div>
                    <div class="show-detail">
                        <i class="fas fa-clock"></i>
                        {{ show.show_time.strftime('%I:%M %p') }}
                    </div>
                    <div class="show-detail">
                        <i class="fas fa-rupee-sign"></i>
                        ₹{{ "%.0f"|format(show.price) }} per seat
                    </div>
                </div>
            </div>
        </div>

        <!-- Seat Map -->
        <div class="seat-map-container">
            <div class="screen">
                <div class="screen-label">
                    <i class="fas fa-video"></i>
                    SCREEN
                </div>
            </div>
            
            <div class="seat-map" id="seatMap">
                <!-- Seats will be generated by JavaScript -->
            </div>
            
            <div class="seat-legend">
                <div class="legend-item">
                    <div class="seat available"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="seat selected"></div>
                    <span>Selected</span>
                </div>
                <div class="legend-item">
                    <div class="seat booked"></div>
                    <span>Booked</span>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary" id="bookingSummary" style="display: none;">
            <div class="summary-header">
                <h3><i class="fas fa-receipt"></i> Booking Summary</h3>
            </div>
            
            <div class="summary-details">
                <div class="summary-row">
                    <span>Selected Seats:</span>
                    <span id="selectedSeatsText">None</span>
                </div>
                <div class="summary-row">
                    <span>Number of Seats:</span>
                    <span id="seatCount">0</span>
                </div>
                <div class="summary-row">
                    <span>Price per Seat:</span>
                    <span>₹{{ "%.0f"|format(show.price) }}</span>
                </div>
                <div class="summary-row total">
                    <span>Total Amount:</span>
                    <span id="totalAmount">₹0</span>
                </div>
            </div>
        </div>

        <!-- Customer Details Form -->
        <div class="customer-form" id="customerForm" style="display: none;">
            <div class="form-header">
                <h3><i class="fas fa-user"></i> Customer Details</h3>
            </div>
            
            <form id="bookingForm" class="booking-form">
                <input type="hidden" id="showId" value="{{ show.id }}">
                <input type="hidden" id="selectedSeats" value="">
                <input type="hidden" id="totalPrice" value="">
                
                <div class="form-group">
                    <label for="customerName">
                        <i class="fas fa-user"></i>
                        Full Name
                    </label>
                    <input type="text" id="customerName" name="customer_name" required>
                </div>
                
                <div class="form-group">
                    <label for="customerEmail">
                        <i class="fas fa-envelope"></i>
                        Email Address
                    </label>
                    <input type="email" id="customerEmail" name="customer_email" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">
                        <i class="fas fa-phone"></i>
                        Phone Number
                    </label>
                    <input type="tel" id="customerPhone" name="customer_phone" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="clearSelection()">
                        <i class="fas fa-undo"></i> Clear Selection
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-credit-card"></i> Proceed to Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-credit-card"></i> Payment</h3>
        </div>
        
        <div class="modal-body">
            <div class="payment-summary">
                <h4>Payment Summary</h4>
                <div class="payment-details">
                    <div class="payment-row">
                        <span>Movie:</span>
                        <span>{{ show.title }}</span>
                    </div>
                    <div class="payment-row">
                        <span>Theater:</span>
                        <span>{{ show.theater_name }}</span>
                    </div>
                    <div class="payment-row">
                        <span>Show Time:</span>
                        <span>{{ show.show_date.strftime('%B %d, %Y') }} {{ show.show_time.strftime('%I:%M %p') }}</span>
                    </div>
                    <div class="payment-row">
                        <span>Seats:</span>
                        <span id="paymentSeats"></span>
                    </div>
                    <div class="payment-row total">
                        <span>Total Amount:</span>
                        <span id="paymentTotal"></span>
                    </div>
                </div>
            </div>
            
            <div class="payment-form">
                <h4>Payment Method</h4>
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="card">
                        <i class="fas fa-credit-card"></i>
                        <span>Credit/Debit Card</span>
                    </div>
                    <div class="payment-method" data-method="upi">
                        <i class="fas fa-mobile-alt"></i>
                        <span>UPI</span>
                    </div>
                    <div class="payment-method" data-method="wallet">
                        <i class="fas fa-wallet"></i>
                        <span>Digital Wallet</span>
                    </div>
                </div>
                
                <div class="card-form" id="cardForm">
                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cardholder Name</label>
                        <input type="text" placeholder="John Doe">
                    </div>
                </div>
                
                <div class="payment-note">
                    <i class="fas fa-info-circle"></i>
                    This is a demo payment system. No actual payment will be processed.
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="closePaymentModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="processPayment()">
                <i class="fas fa-lock"></i> Pay Securely
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const bookedSeats = {{ booked_seats|tojsonfilter }};
const totalSeats = {{ show.total_seats }};
const seatPrice = {{ show.price }};
let selectedSeats = [];

// Generate seat map
function generateSeatMap() {
    const seatMap = document.getElementById('seatMap');
    const rows = Math.ceil(totalSeats / 10);
    
    for (let row = 0; row < rows; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'seat-row';
        
        const rowLabel = document.createElement('div');
        rowLabel.className = 'row-label';
        rowLabel.textContent = String.fromCharCode(65 + row); // A, B, C...
        rowDiv.appendChild(rowLabel);
        
        for (let seat = 1; seat <= 10; seat++) {
            const seatNumber = row * 10 + seat;
            if (seatNumber > totalSeats) break;
            
            const seatDiv = document.createElement('div');
            seatDiv.className = 'seat';
            seatDiv.dataset.seat = `${String.fromCharCode(65 + row)}${seat}`;
            seatDiv.textContent = seat;
            
            if (bookedSeats.includes(`${String.fromCharCode(65 + row)}${seat}`)) {
                seatDiv.classList.add('booked');
            } else {
                seatDiv.classList.add('available');
                seatDiv.addEventListener('click', toggleSeat);
            }
            
            rowDiv.appendChild(seatDiv);
        }
        
        seatMap.appendChild(rowDiv);
    }
}

function toggleSeat(event) {
    const seat = event.target;
    const seatNumber = seat.dataset.seat;
    
    if (seat.classList.contains('selected')) {
        seat.classList.remove('selected');
        seat.classList.add('available');
        selectedSeats = selectedSeats.filter(s => s !== seatNumber);
    } else {
        seat.classList.remove('available');
        seat.classList.add('selected');
        selectedSeats.push(seatNumber);
    }
    
    updateBookingSummary();
}

function updateBookingSummary() {
    const summaryDiv = document.getElementById('bookingSummary');
    const customerForm = document.getElementById('customerForm');
    
    if (selectedSeats.length > 0) {
        summaryDiv.style.display = 'block';
        customerForm.style.display = 'block';
        
        document.getElementById('selectedSeatsText').textContent = selectedSeats.join(', ');
        document.getElementById('seatCount').textContent = selectedSeats.length;
        document.getElementById('totalAmount').textContent = `₹${(selectedSeats.length * seatPrice).toFixed(0)}`;
        
        document.getElementById('selectedSeats').value = JSON.stringify(selectedSeats);
        document.getElementById('totalPrice').value = selectedSeats.length * seatPrice;
    } else {
        summaryDiv.style.display = 'none';
        customerForm.style.display = 'none';
    }
}

function clearSelection() {
    selectedSeats = [];
    document.querySelectorAll('.seat.selected').forEach(seat => {
        seat.classList.remove('selected');
        seat.classList.add('available');
    });
    updateBookingSummary();
}

// Handle booking form submission
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (selectedSeats.length === 0) {
        alert('Please select at least one seat');
        return;
    }
    
    // Show payment modal
    document.getElementById('paymentSeats').textContent = selectedSeats.join(', ');
    document.getElementById('paymentTotal').textContent = `₹${(selectedSeats.length * seatPrice).toFixed(0)}`;
    document.getElementById('paymentModal').style.display = 'block';
});

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
}

async function processPayment() {
    const formData = new FormData(document.getElementById('bookingForm'));
    
    const bookingData = {
        show_id: parseInt(formData.get('showId') || document.getElementById('showId').value),
        customer_name: formData.get('customer_name'),
        customer_email: formData.get('customer_email'),
        customer_phone: formData.get('customer_phone'),
        selected_seats: selectedSeats,
        total_amount: selectedSeats.length * seatPrice
    };
    
    try {
        const response = await fetch('/confirm_booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Simulate payment processing
            setTimeout(() => {
                window.location.href = `/booking_success/${result.booking_id}`;
            }, 2000);
            
            // Show processing message
            document.querySelector('.modal-content').innerHTML = `
                <div class="payment-processing">
                    <div class="loading-spinner"></div>
                    <h3>Processing Payment...</h3>
                    <p>Please wait while we confirm your booking.</p>
                </div>
            `;
        } else {
            alert('Booking failed: ' + result.message);
            closePaymentModal();
        }
    } catch (error) {
        alert('Error processing booking. Please try again.');
        closePaymentModal();
    }
}

// Payment method selection
document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
        this.classList.add('selected');
    });
});

// Initialize seat map when page loads
document.addEventListener('DOMContentLoaded', generateSeatMap);

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('paymentModal');
    if (event.target === modal) {
        closePaymentModal();
    }
}
</script>
{% endblock %}