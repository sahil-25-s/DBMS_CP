{% extends "base.html" %}

{% block title %}Manage Shows - Admin{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-container">
        <div class="admin-header">
            <div class="header-left">
                <h1><i class="fas fa-calendar-alt"></i> Manage Shows</h1>
                <p>Schedule and manage movie shows</p>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="showAddShowModal()">
                    <i class="fas fa-plus"></i>
                    Add New Show
                </button>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>

        {% if shows %}
        <div class="shows-table-container">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Show ID</th>
                            <th>Movie</th>
                            <th>Theater</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Price</th>
                            <th>Available Seats</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for show in shows %}
                        <tr>
                            <td>{{ show.id }}</td>
                            <td>
                                <div class="movie-cell">
                                    <strong>{{ show.title }}</strong>
                                </div>
                            </td>
                            <td>{{ show.theater_name }}</td>
                            <td>
                                <span class="date-cell">{{ show.show_date.strftime('%Y-%m-%d') }}</span>
                                <small>{{ show.show_date.strftime('%A') }}</small>
                            </td>
                            <td>
                                <span class="time-cell">{{ show.show_time.strftime('%I:%M %p') }}</span>
                            </td>
                            <td>
                                <span class="price-cell">₹{{ "%.0f"|format(show.price) }}</span>
                            </td>
                            <td>
                                <div class="seats-cell">
                                    <span class="seats-available">{{ show.available_seats }}</span>
                                    <div class="seats-bar">
                                        {% set occupancy = ((100 - show.available_seats) / 100) * 100 %}
                                        <div class="seats-fill" style="width: {{ occupancy }}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-edit" onclick="editShow({{ show.id }})" title="Edit Show">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon btn-delete" onclick="deleteShow({{ show.id }})" title="Delete Show">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="no-data">
            <i class="fas fa-calendar-alt"></i>
            <h3>No Shows Scheduled</h3>
            <p>Start by scheduling your first movie show</p>
            <button class="btn btn-primary" onclick="showAddShowModal()">
                <i class="fas fa-plus"></i>
                Schedule First Show
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Show Modal -->
<div id="addShowModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Schedule New Show</h3>
            <span class="close" onclick="closeModal('addShowModal')">&times;</span>
        </div>
        
        <form action="{{ url_for('add_show') }}" method="POST" class="modal-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="movie_id">
                        <i class="fas fa-film"></i>
                        Select Movie
                    </label>
                    <select id="movie_id" name="movie_id" required>
                        <option value="">Choose a movie</option>
                        {% for movie in movies %}
                        <option value="{{ movie.id }}">{{ movie.title }} ({{ movie.duration }}min)</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="theater_id">
                        <i class="fas fa-building"></i>
                        Select Theater
                    </label>
                    <select id="theater_id" name="theater_id" required>
                        <option value="">Choose a theater</option>
                        {% for theater in theaters %}
                        <option value="{{ theater.id }}">{{ theater.name }} - {{ theater.location }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="show_date">
                        <i class="fas fa-calendar"></i>
                        Show Date
                    </label>
                    <input type="date" id="show_date" name="show_date" min="{{ (moment()).format('YYYY-MM-DD') }}" required>
                </div>
                
                <div class="form-group">
                    <label for="show_time">
                        <i class="fas fa-clock"></i>
                        Show Time
                    </label>
                    <select id="show_time" name="show_time" required>
                        <option value="">Select time</option>
                        <option value="09:00:00">9:00 AM</option>
                        <option value="12:00:00">12:00 PM</option>
                        <option value="15:00:00">3:00 PM</option>
                        <option value="18:00:00">6:00 PM</option>
                        <option value="21:00:00">9:00 PM</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="price">
                    <i class="fas fa-rupee-sign"></i>
                    Ticket Price (₹)
                </label>
                <input type="number" id="price" name="price" min="50" max="1000" step="10" placeholder="200" required>
                <small>Recommended range: ₹100-500</small>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeModal('addShowModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Schedule Show
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAddShowModal() {
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('show_date').setAttribute('min', today);
    document.getElementById('addShowModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'addShowModal') {
        document.querySelector('#addShowModal form').reset();
    }
}

function editShow(showId) {
    alert(`Edit functionality for show ${showId} would be implemented here`);
}

function deleteShow(showId) {
    if (confirm('Are you sure you want to delete this show? This will also cancel all bookings for this show. This action cannot be undone.')) {
        alert(`Delete functionality for show ${showId} would be implemented here`);
    }
}

// Validate that we have movies and theaters before allowing show creation
document.getElementById('addShowModal').addEventListener('show', function() {
    const movieSelect = document.getElementById('movie_id');
    const theaterSelect = document.getElementById('theater_id');
    
    if (movieSelect.options.length <= 1) {
        alert('You need to add at least one movie before scheduling shows.');
        return false;
    }
    
    if (theaterSelect.options.length <= 1) {
        alert('You need to add at least one theater before scheduling shows.');
        return false;
    }
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            closeModal(modal.id);
        }
    });
}
</script>
{% endblock %}