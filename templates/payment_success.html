{% extends "base.html" %}

{% block title %}Payment Successful{% endblock %}

{% block content %}
<div class="container">
    <div class="payment-success animate-fade-in-up">
        <div class="success-icon">
            <div class="checkmark">‚úì</div>
        </div>
        
        <h1>Payment Successful! üéâ</h1>
        <p>Your payment has been processed successfully. Completing your booking...</p>
        
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Processing your booking...</p>
        </div>
        
        <div id="booking-result" style="display: none;">
            <!-- Booking result will be shown here -->
        </div>
    </div>
</div>

<style>
.payment-success {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius);
    padding: 4rem;
    margin: 4rem auto;
    max-width: 600px;
    text-align: center;
    color: white;
}

.success-icon {
    margin-bottom: 2rem;
}

.checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--success);
    color: white;
    font-size: 3rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    animation: checkmark-bounce 0.6s ease-in-out;
}

@keyframes checkmark-bounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.payment-success h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--success);
}

.payment-success p {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    opacity: 0.9;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-left: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.booking-details {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    text-align: left;
}

.booking-details h3 {
    color: var(--success);
    margin-bottom: 1rem;
    text-align: center;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.detail-row:last-child {
    border-bottom: none;
}

.error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    color: var(--danger);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Get the pending booking data from sessionStorage
    const pendingBookingData = sessionStorage.getItem('pendingBooking');
    
    if (!pendingBookingData) {
        showError('No booking data found. Please start the booking process again.');
        return;
    }
    
    try {
        const bookingData = JSON.parse(pendingBookingData);
        
        // Process the booking
        const response = await fetch('/api/book_tickets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Clear the pending booking data
            sessionStorage.removeItem('pendingBooking');
            
            // Show success and redirect to booking details
            setTimeout(() => {
                window.location.href = `/booking_success/${result.booking_id}`;
            }, 2000);
        } else {
            showError('Booking failed: ' + result.message);
        }
    } catch (error) {
        showError('Error processing booking. Please contact support.');
    }
});

function showError(message) {
    document.querySelector('.loading-spinner').style.display = 'none';
    document.getElementById('booking-result').innerHTML = `
        <div class="error-message">
            <h3>‚ùå Booking Error</h3>
            <p>${message}</p>
            <div style="margin-top: 2rem;">
                <a href="/" class="btn btn-primary">Return to Home</a>
            </div>
        </div>
    `;
    document.getElementById('booking-result').style.display = 'block';
}
</script>
{% endblock %}